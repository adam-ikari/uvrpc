# UVRPC Code Generator

The UVRPC code generator (`uvrpc-gen`) is a standalone executable that generates RPC server and client code from FlatBuffers schema files.

## Building the Generator

The generator is built using PyInstaller and can be packaged as a standalone executable.

### Using Make

```bash
# Build the generator
make generator

# Build and install system-wide
make generator-install

# Uninstall system-wide
make generator-uninstall
```

### Manual Build

```bash
cd tools
./build_generator.sh
```

The executable will be created at `tools/dist/uvrpc-gen`.

## Installation

### System-wide Installation

```bash
make generator-install
```

This installs the generator to `/usr/local/bin/uvrpc-gen`, making it available system-wide.

### Manual Installation

```bash
sudo cp tools/dist/uvrpc-gen /usr/local/bin/
sudo chmod +x /usr/local/bin/uvrpc-gen
```

## Usage

### Basic Syntax

```bash
uvrpc-gen --flatcc <flatcc_path> -o <output_dir> <schema_file>
```

### Options

- `--flatcc <path>`: Path to FlatCC compiler (required)
- `-o <dir>`: Output directory for generated files (default: `generated`)
- `<schema_file>`: FlatBuffers schema file to process (required)
- `--help`: Show help message

### Examples

#### Generate Server/Client Code

```bash
uvrpc-gen \
    --flatcc /usr/local/bin/flatcc \
    -o generated \
    schema/rpc_api.fbs
```

#### Generate Broadcast Code

```bash
uvrpc-gen \
    --flatcc /usr/local/bin/flatcc \
    -o generated \
    schema/rpc_broadcast.fbs
```

### Generated Files

For a service named `MyService` in namespace `myapp`:

**Server/Client Mode:**
- `myapp_my_api.h` - API header file
- `myapp_my_server_stub.c` - Server implementation stub
- `myapp_my_client.c` - Client implementation
- `myapp_my_rpc_common.h` - Common definitions
- `myapp_my_rpc_common.c` - Common utilities
- `myapp_builder.h` - FlatBuffers builder (from FlatCC)
- `myapp_reader.h` - FlatBuffers reader (from FlatCC)

**Broadcast Mode:**
- `myapp_my_api.h` - API header file
- `myapp_my_broadcast_publisher.c` - Publisher implementation
- `myapp_my_broadcast_subscriber.c` - Subscriber implementation

## Schema Format

### Server/Client Mode

```flatbuffers
namespace myapp;

table AddRequest {
    a: int32;
    b: int32;
}

table AddResponse {
    result: int32;
}

rpc_service MathService {
    Add(AddRequest):AddResponse;
}
```

### Broadcast Mode

```flatbuffers
namespace myapp;

table NewsPublishRequest {
    title: string;
    content: string;
}

table NewsPublishResponse {
    success: bool;
}

// Service name containing "Broadcast" generates broadcast code
rpc_service NewsBroadcastService {
    PublishNews(NewsPublishRequest):NewsPublishResponse;
}
```

## Requirements for Generated Code

The generated code requires:
- UVRPC library headers and library
- libuv
- FlatBuffers (generated by FlatCC)
- mimalloc (optional, can use system allocator)

## Troubleshooting

### PyInstaller Not Found

```bash
pip3 install pyinstaller
```

### FlatCC Not Found

Ensure FlatCC is built and available:

```bash
make build
# Or specify the path explicitly
uvrpc-gen --flatcc /path/to/flatcc -o generated schema.fbs
```

### Permission Denied

If installing system-wide:

```bash
sudo make generator-install
```

## Cross-Platform Building

The generator works on Linux, macOS, and Windows. Build on the target platform:

```bash
# Linux
cd tools && ./build_generator.sh

# macOS
cd tools && ./build_generator.sh

# Windows (PowerShell)
cd tools
pyinstaller --onefile --clean rpc_dsl_generator.spec
```

## License

The code generator is part of UVRPC and follows the same license.
## Portable Builds

### Building for Different Linux Distributions

The generator can be built in different configurations to ensure compatibility across various Linux systems.

#### Standard Build

```bash
make generator
```

**Characteristics:**
- Uses system Python and libraries
- Links with system glibc
- Size: ~15-20MB
- Compatibility: Matches build system

#### Portable Build (glibc 2.17)

```bash
make generator-portable
```

**Characteristics:**
- Built with CentOS 7 (glibc 2.17)
- Compatible with most modern Linux distributions
- Size: ~20-25MB
- Compatibility: CentOS 7+, Ubuntu 16.04+, Debian 8+, RHEL 7+

**Requires:** Docker

**Use case:** Distribute to users on older Linux systems

#### Static Build (musl)

```bash
make generator-static
```

**Characteristics:**
- Built with Alpine Linux (musl libc)
- Fully statically linked
- Size: ~10-15MB (smallest)
- Compatibility: All Linux distributions

**Requires:** Docker

**Use case:** Maximum portability, minimal dependencies

### Comparison

| Build Type | glibc Version | Size | Portability | Docker Required |
|------------|---------------|------|-------------|----------------|
| Standard   | System        | ~20MB | Medium      | No             |
| Portable   | 2.17          | ~25MB | High        | Yes            |
| Static     | musl          | ~15MB | Very High   | Yes            |

### Choosing the Right Build

- **Development**: Use `make generator` (fastest)
- **Modern Linux**: Use `make generator-portable` (good compatibility)
- **All Linux**: Use `make generator-static` (best compatibility)
- **Unknown target**: Use `make generator-static` (safest option)

### Docker Builds

Both portable and static builds use Docker to ensure consistent build environment:

```bash
# Build portable executable (CentOS 7)
cd tools
./build_generator_portable.sh

# Build static executable (Alpine)
cd tools
./build_generator_static.sh
```

### Checking glibc Version

To check the glibc version required by an executable:

```bash
ldd dist/uvrpc-gen | grep libc
```

To check system glibc version:

```bash
ldd --version | head -1
```

### Compatibility Matrix

| Build Type | Ubuntu 14.04 | Ubuntu 16.04 | Ubuntu 18.04+ | CentOS 7 | CentOS 8+ | Debian 8+ |
|------------|--------------|--------------|---------------|---------|----------|-----------|
| Standard   | ?            | ?            | ✓             | ?       | ✓        | ✓         |
| Portable   | ✗            | ✓            | ✓             | ✓       | ✓        | ✓         |
| Static     | ✓            | ✓            | ✓             | ✓       | ✓        | ✓         |

Legend:
- ✓: Compatible
- ✗: Not compatible
- ?: Depends on build system


## Bundled FlatCC Build

### Build with FlatCC Included

```bash
make generator-with-flatcc
```

**Characteristics:**
- Includes FlatCC compiler in the executable
- No external FlatCC dependency
- Size: ~25-30MB (largest)
- Compatibility: Same as standard build
- Convenience: Best for users without FlatCC

### Manual Build with FlatCC

```bash
cd tools
./build_generator_with_flatcc.sh
```

### How It Works

1. **Auto-detect FlatCC**: The build script searches for FlatCC in:
   - `build/flatcc/flatcc`
   - `deps/flatcc/bin/flatcc`
   - System PATH

2. **Build if Missing**: If FlatCC not found, it builds it first using `make build`

3. **Bundle**: PyInstaller packages FlatCC with the generator

4. **Auto-detect at Runtime**: The generator automatically finds bundled FlatCC

### Usage

With bundled FlatCC, you don't need to specify `--flatcc`:

```bash
# Without bundled FlatCC (requires --flatcc)
./dist/uvrpc-gen --flatcc /path/to/flatcc -o generated schema.fbs

# With bundled FlatCC (no --flatcc needed)
./dist/uvrpc-gen -o generated schema.fbs
```

### Comparison

| Build Type | FlatCC | Size | Dependencies | Convenience |
|------------|--------|------|--------------|-------------|
| Standard   | External | ~20MB | Requires FlatCC | Low |
| Bundled    | Internal | ~30MB | None | High |
| Portable   | External | ~25MB | Requires FlatCC | Medium |
| Static     | External | ~15MB | Requires FlatCC | Medium |

### Choosing the Right Build

- **Production**: `make generator-with-flatcc` - No external dependencies
- **Development**: `make generator` - Fastest build
- **Distribution**: `make generator-with-flatcc` - Best user experience
- **Unknown target**: `make generator-with-flatcc` - Safest option

### Advantages of Bundled FlatCC

1. ✅ **Zero Setup**: Users don't need to install FlatCC
2. ✅ **Consistent Version**: Always uses the same FlatCC version
3. ✅ **Simpler Usage**: No need to specify `--flatcc` path
4. ✅ **Portable**: Works on any system without FlatCC
5. ✅ **Reliable**: Eliminates version compatibility issues

### Disadvantages

1. ❌ Larger executable size (~10MB extra)
2. ❌ Longer build time (needs to build FlatCC first)
3. ❌ Longer startup time (unpacking FlatCC)

