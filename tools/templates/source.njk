/**
 * Auto-generated source file for {{ serviceName }}
 * Generated from {{ yamlPath }}
 * Do not edit this file manually
 */

#include "{{ headerFile }}"
#include <mpack.h>
#include <stdlib.h>
#include <string.h>

{% for method in methods %}

/* ==================== {{ method.name }} Request ==================== */

int {{ functionName(serviceName, method.name, 'SerializeRequest') }}(
    const {{ structName(serviceName, method.name, 'Request') }}_t* request,
    uint8_t** output,
    size_t* output_size
) {
    if (!request || !output || !output_size) {
        return -1;
    }

    char buffer[4096];
    mpack_writer_t writer;
    mpack_writer_init(&writer, buffer, sizeof(buffer));

    mpack_start_map(&writer, {{ method.request.fields | length }});

{% for field in method.request.fields %}
    /* {{ field.name }} */
    mpack_write_cstr(&writer, "{{ field.name }}");
{% if field.type == 'string' %}
    if (request->{{ field.name }}) {
        mpack_write_cstr(&writer, request->{{ field.name }});
    } else {
        mpack_write_nil(&writer);
    }
{% elif field.type == 'int' %}
    mpack_write_int(&writer, request->{{ field.name }});
{% elif field.type == 'float' %}
    mpack_write_double(&writer, request->{{ field.name }});
{% elif field.type == 'bool' %}
    mpack_write_bool(&writer, request->{{ field.name }});
{% elif field.type == 'bytes' %}
    if (request->{{ field.name }} && request->{{ field.name }}_size > 0) {
        mpack_write_bin(&writer, (const char*)request->{{ field.name }}, request->{{ field.name }}_size);
    } else {
        mpack_write_nil(&writer);
    }
{% elif field.type == 'array' %}
    if (request->{{ field.name }} && request->{{ field.name }}_count > 0) {
        mpack_start_array(&writer, request->{{ field.name }}_count);
        for (size_t i = 0; i < request->{{ field.name }}_count; i++) {
            mpack_write_int(&writer, request->{{ field.name }}[i]);
        }
        mpack_finish_array(&writer);
    } else {
        mpack_write_nil(&writer);
    }
{% else %}
    mpack_write_nil(&writer);
{% endif %}

{% endfor %}
    mpack_finish_map(&writer);

    if (mpack_writer_error(&writer) != mpack_ok) {
        return -1;
    }

    size_t size = mpack_writer_buffer_used(&writer);
    *output = (uint8_t*)malloc(size);
    if (!*output) {
        return -1;
    }

    memcpy(*output, buffer, size);
    *output_size = size;

    return 0;
}

int {{ functionName(serviceName, method.name, 'DeserializeRequest') }}(
    const uint8_t* data,
    size_t size,
    {{ structName(serviceName, method.name, 'Request') }}_t* request
) {
    if (!data || !request) {
        return -1;
    }

    memset(request, 0, sizeof({{ structName(serviceName, method.name, 'Request') }}_t));

    mpack_reader_t reader;
    mpack_reader_init_data(&reader, (const char*)data, size);

    uint32_t count = mpack_expect_map_max(&reader, 100);

    for (uint32_t i = count; i > 0 && mpack_reader_error(&reader) == mpack_ok; --i) {
        char key[128];
        mpack_expect_cstr(&reader, key, sizeof(key));

{% for field in method.request.fields %}
        if (strcmp(key, "{{ field.name }}") == 0) {
{% if field.type == 'string' %}
            uint32_t len = mpack_expect_str(&reader);
            if (mpack_reader_error(&reader) == mpack_ok && len > 0) {
                const char* str = mpack_read_bytes_inplace(&reader, len);
                if (mpack_reader_error(&reader) == mpack_ok && str) {
                    request->{{ field.name }} = strndup(str, len);
                }
                mpack_done_str(&reader);
            } else {
                mpack_discard(&reader);
            }
{% elif field.type == 'int' %}
            request->{{ field.name }} = mpack_expect_int(&reader);
{% elif field.type == 'float' %}
            request->{{ field.name }} = mpack_expect_double(&reader);
{% elif field.type == 'bool' %}
            request->{{ field.name }} = mpack_expect_bool(&reader);
{% elif field.type == 'bytes' %}
            uint32_t bin_size = mpack_expect_bin(&reader);
            if (mpack_reader_error(&reader) == mpack_ok && bin_size > 0) {
                const char* bin_data = mpack_read_bytes_inplace(&reader, bin_size);
                if (mpack_reader_error(&reader) == mpack_ok && bin_data) {
                    request->{{ field.name }} = ({{ cType(field.type) }})malloc(bin_size);
                    if (request->{{ field.name }}) {
                        memcpy(request->{{ field.name }}, bin_data, bin_size);
                        request->{{ field.name }}_size = bin_size;
                    }
                }
                mpack_done_bin(&reader);
            } else {
                mpack_discard(&reader);
            }
{% elif field.type == 'array' %}
            uint32_t array_count = mpack_expect_array(&reader);
            if (mpack_reader_error(&reader) == mpack_ok && array_count > 0) {
                request->{{ field.name }} = ({{ cType('int') }}*)malloc(array_count * sizeof({{ cType('int') }}));
                if (request->{{ field.name }}) {
                    request->{{ field.name }}_count = array_count;
                    for (uint32_t j = 0; j < array_count; j++) {
                        request->{{ field.name }}[j] = mpack_expect_int(&reader);
                    }
                }
                mpack_done_array(&reader);
            } else {
                mpack_discard(&reader);
            }
{% else %}
            mpack_discard(&reader);
{% endif %}
{% else %}
        } else {
            mpack_discard(&reader);
{% endfor %}
        }
    }

    mpack_done_map(&reader);

    if (mpack_reader_error(&reader) != mpack_ok) {
        {{ functionName(serviceName, method.name, 'FreeRequest') }}(request);
        mpack_reader_destroy(&reader);
        return -1;
    }

    mpack_reader_destroy(&reader);
    return 0;
}

void {{ functionName(serviceName, method.name, 'FreeRequest') }}(
    {{ structName(serviceName, method.name, 'Request') }}_t* request
) {
    if (!request) {
        return;
    }

{% for field in method.request.fields %}
{% if field.type == 'string' %}
    if (request->{{ field.name }}) {
        free(request->{{ field.name }});
        request->{{ field.name }} = NULL;
    }
{% elif field.type == 'bytes' or field.type == 'array' %}
    if (request->{{ field.name }}) {
        free(request->{{ field.name }});
        request->{{ field.name }} = NULL;
        request->{{ field.name }}_size = 0;
        request->{{ field.name }}_count = 0;
    }
{% endif %}
{% endfor %}
}

/* ==================== {{ method.name }} Response ==================== */

int {{ functionName(serviceName, method.name, 'SerializeResponse') }}(
    const {{ structName(serviceName, method.name, 'Response') }}_t* response,
    uint8_t** output,
    size_t* output_size
) {
    if (!response || !output || !output_size) {
        return -1;
    }

    char buffer[4096];
    mpack_writer_t writer;
    mpack_writer_init(&writer, buffer, sizeof(buffer));

    mpack_start_map(&writer, {{ method.response.fields | length }});

{% for field in method.response.fields %}
    /* {{ field.name }} */
    mpack_write_cstr(&writer, "{{ field.name }}");
{% if field.type == 'string' %}
    if (response->{{ field.name }}) {
        mpack_write_cstr(&writer, response->{{ field.name }});
    } else {
        mpack_write_nil(&writer);
    }
{% elif field.type == 'int' %}
    mpack_write_int(&writer, response->{{ field.name }});
{% elif field.type == 'float' %}
    mpack_write_double(&writer, response->{{ field.name }});
{% elif field.type == 'bool' %}
    mpack_write_bool(&writer, response->{{ field.name }});
{% elif field.type == 'bytes' %}
    if (response->{{ field.name }} && response->{{ field.name }}_size > 0) {
        mpack_write_bin(&writer, (const char*)response->{{ field.name }}, response->{{ field.name }}_size);
    } else {
        mpack_write_nil(&writer);
    }
{% elif field.type == 'array' %}
    if (response->{{ field.name }} && response->{{ field.name }}_count > 0) {
        mpack_start_array(&writer, response->{{ field.name }}_count);
        for (size_t i = 0; i < response->{{ field.name }}_count; i++) {
            mpack_write_int(&writer, response->{{ field.name }}[i]);
        }
        mpack_finish_array(&writer);
    } else {
        mpack_write_nil(&writer);
    }
{% else %}
    mpack_write_nil(&writer);
{% endif %}

{% endfor %}
    mpack_finish_map(&writer);

    if (mpack_writer_error(&writer) != mpack_ok) {
        return -1;
    }

    size_t size = mpack_writer_buffer_used(&writer);
    *output = (uint8_t*)malloc(size);
    if (!*output) {
        return -1;
    }

    memcpy(*output, buffer, size);
    *output_size = size;

    return 0;
}

int {{ functionName(serviceName, method.name, 'DeserializeResponse') }}(
    const uint8_t* data,
    size_t size,
    {{ structName(serviceName, method.name, 'Response') }}_t* response
) {
    if (!data || !response) {
        return -1;
    }

    memset(response, 0, sizeof({{ structName(serviceName, method.name, 'Response') }}_t));

    mpack_reader_t reader;
    mpack_reader_init_data(&reader, (const char*)data, size);

    uint32_t count = mpack_expect_map_max(&reader, 100);

    for (uint32_t i = count; i > 0 && mpack_reader_error(&reader) == mpack_ok; --i) {
        char key[128];
        mpack_expect_cstr(&reader, key, sizeof(key));

{% for field in method.response.fields %}
        if (strcmp(key, "{{ field.name }}") == 0) {
{% if field.type == 'string' %}
            uint32_t len = mpack_expect_str(&reader);
            if (mpack_reader_error(&reader) == mpack_ok && len > 0) {
                const char* str = mpack_read_bytes_inplace(&reader, len);
                if (mpack_reader_error(&reader) == mpack_ok && str) {
                    response->{{ field.name }} = strndup(str, len);
                }
                mpack_done_str(&reader);
            } else {
                mpack_discard(&reader);
            }
{% elif field.type == 'int' %}
            response->{{ field.name }} = mpack_expect_int(&reader);
{% elif field.type == 'float' %}
            response->{{ field.name }} = mpack_expect_double(&reader);
{% elif field.type == 'bool' %}
            response->{{ field.name }} = mpack_expect_bool(&reader);
{% elif field.type == 'bytes' %}
            uint32_t bin_size = mpack_expect_bin(&reader);
            if (mpack_reader_error(&reader) == mpack_ok && bin_size > 0) {
                const char* bin_data = mpack_read_bytes_inplace(&reader, bin_size);
                if (mpack_reader_error(&reader) == mpack_ok && bin_data) {
                    response->{{ field.name }} = ({{ cType(field.type) }})malloc(bin_size);
                    if (response->{{ field.name }}) {
                        memcpy(response->{{ field.name }}, bin_data, bin_size);
                        response->{{ field.name }}_size = bin_size;
                    }
                }
                mpack_done_bin(&reader);
            } else {
                mpack_discard(&reader);
            }
{% elif field.type == 'array' %}
            uint32_t array_count = mpack_expect_array(&reader);
            if (mpack_reader_error(&reader) == mpack_ok && array_count > 0) {
                response->{{ field.name }} = ({{ cType('int') }}*)malloc(array_count * sizeof({{ cType('int') }}));
                if (response->{{ field.name }}) {
                    response->{{ field.name }}_count = array_count;
                    for (uint32_t j = 0; j < array_count; j++) {
                        response->{{ field.name }}[j] = mpack_expect_int(&reader);
                    }
                }
                mpack_done_array(&reader);
            } else {
                mpack_discard(&reader);
            }
{% else %}
            mpack_discard(&reader);
{% endif %}
{% else %}
        } else {
            mpack_discard(&reader);
{% endfor %}
        }
    }

    mpack_done_map(&reader);

    if (mpack_reader_error(&reader) != mpack_ok) {
        {{ functionName(serviceName, method.name, 'FreeResponse') }}(response);
        mpack_reader_destroy(&reader);
        return -1;
    }

    mpack_reader_destroy(&reader);
    return 0;
}

void {{ functionName(serviceName, method.name, 'FreeResponse') }}(
    {{ structName(serviceName, method.name, 'Response') }}_t* response
) {
    if (!response) {
        return;
    }

{% for field in method.response.fields %}
{% if field.type == 'string' %}
    if (response->{{ field.name }}) {
        free(response->{{ field.name }});
        response->{{ field.name }} = NULL;
    }
{% elif field.type == 'bytes' or field.type == 'array' %}
    if (response->{{ field.name }}) {
        free(response->{{ field.name }});
        response->{{ field.name }} = NULL;
        response->{{ field.name }}_size = 0;
        response->{{ field.name }}_count = 0;
    }
{% endif %}
{% endfor %}
}

{% endfor %}