/**
 * Auto-generated client source file for {{ serviceName }}
 * Generated from {{ yamlPath }}
 * Do not edit this file manually
 */

#include "{{ serviceName | lower }}_gen_client.h"
#include "{{ serviceName | lower }}_gen.h"
#include <stdlib.h>
#include <string.h>

{% for method in methods %}

/* ==================== {{ method.name }} Client API ==================== */

int {{ functionName(serviceName, method.name, 'Async') }}(
    uvrpc_client_t* client,
    const {{ structName(serviceName, method.name, 'Request') }}_t* request,
    uvrpc_async_t* async
) {
    if (!client || !request || !async) {
        return UVRPC_ERROR_INVALID_PARAM;
    }

    /* Serialize request */
    uint8_t* serialized = NULL;
    size_t serialized_size = 0;
    if ({{ functionName(serviceName, method.name, 'SerializeRequest') }}(request, &serialized, &serialized_size) != 0) {
        return UVRPC_ERROR;
    }

    /* Send async call */
    int rc = uvrpc_client_call_async(client, "{{ serviceName }}.{{ method.name }}", "{{ method.name }}",
                                      serialized, serialized_size, async);
    
    /* Free serialized data (uvrpc_client_call_async takes ownership) */
    if (rc != UVRPC_OK) {
        free(serialized);
    }

    return rc;
}

int {{ functionName(serviceName, method.name, 'AsyncTimeout') }}(
    uvrpc_client_t* client,
    const {{ structName(serviceName, method.name, 'Request') }}_t* request,
    uvrpc_async_t* async,
    uint64_t timeout_ms
) {
    (void)timeout_ms; /* Timeout is handled in uvrpc_async_await_timeout */
    return {{ functionName(serviceName, method.name, 'Async') }}(client, request, async);
}

int {{ functionName(serviceName, method.name, 'Await') }}(
    const uvrpc_async_result_t* result,
    {{ structName(serviceName, method.name, 'Response') }}_t* response
) {
    if (!result || !response) {
        return UVRPC_ERROR_INVALID_PARAM;
    }

    if (result->status != UVRPC_OK) {
        return result->status;
    }

    /* Deserialize response */
    if ({{ functionName(serviceName, method.name, 'DeserializeResponse') }}(
            result->response_data, result->response_size, response) != 0) {
        return UVRPC_ERROR;
    }

    return UVRPC_OK;
}

int {{ functionName(serviceName, method.name, 'CallAsync') }}(
    uvrpc_client_t* client,
    const {{ structName(serviceName, method.name, 'Request') }}_t* request,
    {{ structName(serviceName, method.name, 'Response') }}_t* response,
    uv_loop_t* loop
) {
    if (!client || !request || !response || !loop) {
        return UVRPC_ERROR_INVALID_PARAM;
    }

    /* Create async context */
    uvrpc_async_t* async = uvrpc_async_create(loop);
    if (!async) {
        return UVRPC_ERROR_NO_MEMORY;
    }

    /* Send async call */
    int rc = {{ functionName(serviceName, method.name, 'Async') }}(client, request, async);
    if (rc != UVRPC_OK) {
        uvrpc_async_free(async);
        return rc;
    }

    /* Await response */
    const uvrpc_async_result_t* result = uvrpc_async_await(async);
    rc = {{ functionName(serviceName, method.name, 'Await') }}(result, response);

    /* Free async context */
    uvrpc_async_free(async);

    return rc;
}

{% endfor %}