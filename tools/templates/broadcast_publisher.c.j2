/* Auto-generated by UVRPC DSL Generator */
#include "{{ namespace|lower }}_{{ service_name_lower }}_api.h"
#include <string.h>

/* ============================================================
   Broadcast Publisher Implementation
   ============================================================ */

uvrpc_publisher_t* uvrpc_{{ service_name_lower }}_create_publisher(uv_loop_t* loop, 
                                                          const char* address) {
    /* Create configuration */
    uvrpc_config_t* config = uvrpc_config_new();
    uvrpc_config_set_loop(config, loop);
    uvrpc_config_set_address(config, address);
    uvrpc_config_set_transport(config, UVRPC_TRANSPORT_UDP);
    uvrpc_config_set_comm_type(config, UVRPC_COMM_BROADCAST);
    
    /* Create publisher */
    uvrpc_publisher_t* publisher = uvrpc_publisher_create(config);
    uvrpc_config_free(config);
    
    return publisher;
}

uvrpc_error_t uvrpc_{{ service_name_lower }}_start_publisher(uvrpc_publisher_t* publisher) {
    return uvrpc_publisher_start(publisher);
}

void uvrpc_{{ service_name_lower }}_stop_publisher(uvrpc_publisher_t* publisher) {
    uvrpc_publisher_stop(publisher);
}

void uvrpc_{{ service_name_lower }}_free_publisher(uvrpc_publisher_t* publisher) {
    uvrpc_publisher_free(publisher);
}

/* Broadcast publish implementations */
{% for method in service.methods -%}

/* Context for {{ method.name }} publish callback */
typedef struct {
    uvrpc_callback_t user_callback;
    void* user_ctx;
} {{ service_name_lower }}_{{ method.name }}_publish_ctx_t;

/* Internal callback for {{ method.name }} publish */
static void {{ service_name_lower }}_on_{{ method.name }}_published(int status, void* ctx) {
    {{ service_name_lower }}_{{ method.name }}_publish_ctx_t* pub_ctx = ({{ service_name_lower }}_{{ method.name }}_publish_ctx_t*)ctx;
    
    /* Call user callback if provided */
    if (pub_ctx->user_callback) {
        pub_ctx->user_callback(status, pub_ctx->user_ctx);
    }
    
    /* Free context */
    uvrpc_free(pub_ctx);
}

uvrpc_error_t uvrpc_{{ service_name_lower }}_{{ method.name }}(uvrpc_publisher_t* publisher,
    uvrpc_callback_t callback, void* ctx
    {%- for field in method.request_fields -%}
    {%- if field.is_array %}, const {{ field.type }}* {{ field.name }}_data, size_t {{ field.name }}_size
    {%- else %}, {{ field.type }} {{ field.name }}
    {%- endif -%}
    {%- endfor %}) {
    
    /* Create FlatBuffers builder */
    flatcc_builder_t builder;
    flatcc_builder_init(&builder);
    
    /* Build {{ method.name }} request */
{%- for field in method.request_fields -%}
{%- if field.is_array %}
    {{ namespace }}_{{ method.request }}_{{ field.name }}_vec_start(&builder);
    {{ namespace }}_{{ method.request }}_{{ field.name }}_vec_append(&builder, {{ field.name }}_data, {{ field.name }}_size);
    flatbuffers_ref_t {{ field.name }}_vec = {{ namespace }}_{{ method.request }}_{{ field.name }}_vec_end(&builder);
{%- else %}
    {{ namespace }}_{{ method.request }}_{{ field.name }}_create(&builder, {{ field.name }});
{%- endif -%}
{%- endfor %}
    
    {{ namespace }}_{{ method.request }}_create(&builder
        {%- for field in method.request_fields -%}
        {%- if field.is_array %}, {{ field.name }}_vec
        {%- else %}, {{ field.name }}
        {%- endif -%}
        {%- endfor %}
    );
    
    /* Finish buffer */
    flatbuffers_ref_t root = {{ namespace }}_{{ method.request }}_as_root(&builder);
    flatbuffers_uint8_vec_ref_t data_ref = flatbuffers_uint8_vec_create(&builder, 
        flatcc_builder_get_direct_buffer_start(&builder, root.offset), 
        flatcc_builder_get_buffer_size(&builder));
    
    size_t size = flatcc_builder_get_buffer_size(&builder);
    const uint8_t* data = flatcc_builder_get_direct_buffer(&builder);
    
    /* Create publish context */
    {{ service_name_lower }}_{{ method.name }}_publish_ctx_t* pub_ctx = ({{ service_name_lower }}_{{ method.name }}_publish_ctx_t*)uvrpc_alloc(sizeof({{ service_name_lower }}_{{ method.name }}_publish_ctx_t));
    pub_ctx->user_callback = callback;
    pub_ctx->user_ctx = ctx;
    
    /* Publish message */
    uvrpc_error_t err = uvrpc_publisher_publish(publisher, "{{ method.name }}", data, size, 
        {{ service_name_lower }}_on_{{ method.name }}_published, pub_ctx);
    
    /* Cleanup builder */
    flatcc_builder_clear(&builder);
    
    return err;
}

{% endfor -%}